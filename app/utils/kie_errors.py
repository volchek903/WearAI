from __future__ import annotations

import re
from typing import Optional


def _extract_code(text: str) -> Optional[str]:
    """
    KIE —á–∞—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –≤–∏–¥–∞:
    "... (code=422)" / "code=401" –∏ —Ç.–ø.
    """
    m = re.search(r"code=(\d+)", text)
    return m.group(1) if m else None


def kie_error_to_user_text(err: Exception) -> str:
    """
    –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –æ—à–∏–±–∫—É KIE –≤ –ø–æ–Ω—è—Ç–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    –í–∞–∂–Ω–æ: –ù–ï –≤—ã–≤–æ–¥–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å—ã—Ä—ã–µ —Ç–µ—Ö. –¥–µ—Ç–∞–ª–∏/—Ç–µ–∫—Å—Ç—ã –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.
    """
    raw = (str(err) or "").strip()
    raw_l = raw.lower()
    code = _extract_code(raw)

    header = "–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ üòÖ"

    # 422 / rejected ‚Äî —á–∞—â–µ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç- –∏–ª–∏ input-—Ñ–∏–ª—å—Ç—Ä—ã
    if code == "422" or "rejected" in raw_l:
        return (
            f"{header}\n\n"
            "–°–µ—Ä–≤–∏—Å –æ—Ç–∫–ª–æ–Ω–∏–ª –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–æ—à–∏–±–∫–∞ 422). –û–±—ã—á–Ω–æ —ç—Ç–æ –æ–¥–Ω–∞ –∏–∑ –ø—Ä–∏—á–∏–Ω:\n"
            "‚Ä¢ –í —Ç–µ–∫—Å—Ç–µ/–∑–∞–ø—Ä–æ—Å–µ —É–ø–æ–º–∏–Ω–∞–µ—Ç—Å—è –Ω–µ—Å–æ–≤–µ—Ä—à–µ–Ω–Ω–æ–ª–µ—Ç–Ω–∏–π –≤–æ–∑—Ä–∞—Å—Ç (< 18).\n"
            "‚Ä¢ –ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Å–∏—Ç –∏–∑–º–µ–Ω–∏—Ç—å –≤–æ–∑—Ä–∞—Å—Ç/–ª–∏—á–Ω–æ—Å—Ç—å —á–µ–ª–æ–≤–µ–∫–∞ (–æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Å—Ç–æ—Ä–æ–Ω—É < 18).\n"
            "‚Ä¢ –í –æ–ø–∏—Å–∞–Ω–∏–∏/–∫–∞–¥—Ä–µ –µ—Å—Ç—å —Å–ª–∏—à–∫–æ–º —Å–µ–∫—Å—É–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∏–ª–∏ –æ—Ç–∫—Ä–æ–≤–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç.\n"
            "‚Ä¢ –ù–∞ —Ñ–æ—Ç–æ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–µ–±—ë–Ω–æ–∫/–ø–æ–¥—Ä–æ—Å—Ç–æ–∫ ‚Äî –∏–Ω–æ–≥–¥–∞ —Ñ–∏–ª—å—Ç—Ä –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥–∞–∂–µ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Å—Ü–µ–Ω—ã.\n"
            "‚Ä¢ –†–µ–∂–µ: —Å–ª–∏—à–∫–æ–º ¬´—à—É–º–Ω—ã–π¬ª –ø—Ä–æ–º–ø—Ç (–º–Ω–æ–≥–æ –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤/–º—É—Å–æ—Ä–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞).\n\n"
            "–ß—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:\n"
            "1) –£–±–µ—Ä–∏ –ª—é–±–æ–π –≤–æ–∑—Ä–∞—Å—Ç < 18 –∏ –∑–∞–º–µ–Ω–∏ –Ω–∞ ¬´–≤–∑—Ä–æ—Å–ª—ã–π 21+¬ª.\n"
            "2) –£–ø—Ä–æ—Å—Ç–∏—Ç—å —Ç–µ–∫—Å—Ç: —Å—Ç–∏–ª—å/—Å–≤–µ—Ç/—Ñ–æ–Ω/–ø–æ–∑–∞ ‚Äî –±–µ–∑ —Å–ø–æ—Ä–Ω—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫.\n"
            "3) –ó–∞–º–µ–Ω–∏ —Ñ–æ—Ç–æ –Ω–∞ –±–æ–ª–µ–µ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω–æ–µ.\n"
            "4) –ü–æ–≤—Ç–æ—Ä–∏ –ø–æ–ø—ã—Ç–∫—É —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É (–∏–Ω–æ–≥–¥–∞ —Ñ–∏–ª—å—Ç—Ä —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ).\n\n"
            "–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è ‚Äî –Ω–∞–∂–º–∏ ¬´–°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ¬ª –∏ –æ–ø–∏—à–∏, —á—Ç–æ –∏–º–µ–Ω–Ω–æ –Ω–µ —Ç–∞–∫."
        )

    # –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    if code == "401":
        return (
            f"{header}\n\n"
            "–ü–æ—Ö–æ–∂–µ, –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ API (401).\n"
            "–û–±—ã—á–Ω–æ —ç—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ KIE_API_KEY –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–π.\n\n"
            "–ß—Ç–æ —Å–¥–µ–ª–∞—Ç—å:\n"
            "‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å .env –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é KIE_API_KEY\n"
            "‚Ä¢ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è .env"
        )

    # Rate limit
    if code == "429":
        return (
            f"{header}\n\n"
            "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∑–∞ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è (429).\n"
            "–ü–æ–ø—Ä–æ–±—É–π –ø–æ–≤—Ç–æ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ 30‚Äì60 —Å–µ–∫—É–Ω–¥."
        )

    # –°–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π payload (–∏–Ω–æ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 413)
    if code == "413" or "payload too large" in raw_l or "entity too large" in raw_l:
        return (
            f"{header}\n\n"
            "–í—Ö–æ–¥–Ω—ã–µ —Ñ–∞–π–ª—ã —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–∏–µ.\n\n"
            "–ß—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:\n"
            "‚Ä¢ –û—Ç–ø—Ä–∞–≤—å —Ñ–æ—Ç–æ –º–µ–Ω—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞/—Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è\n"
            "‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ (–±–µ–∑ 4K/RAW/—Å–∫—Ä–∏–Ω–æ–≤ –±–æ–ª—å—à–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞)"
        )

    # –¢–∞–π–º–∞—É—Ç—ã –∑–∞–¥–∞—á / —Å–µ—Ç–∏
    if "timeout" in raw_l or "task timeout" in raw_l:
        return (
            f"{header}\n\n"
            "–°–µ—Ä–≤–∏—Å –Ω–µ —É—Å–ø–µ–ª –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å –≤–æ–≤—Ä–µ–º—è (—Ç–∞–π–º–∞—É—Ç).\n\n"
            "–ß—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:\n"
            "‚Ä¢ –ù–∞–∂–º–∏ ¬´‚úÖ –í—Å—ë –≤–µ—Ä–Ω–æ¬ª –µ—â—ë —Ä–∞–∑\n"
            "‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π –ø–æ–∑–∂–µ (–∏–Ω–æ–≥–¥–∞ –æ—á–µ—Ä–µ–¥—å –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω–∞)\n"
            "‚Ä¢ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –ø—Ä–æ–º–ø—Ç –∏/–∏–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ –Ω–∞ –º–µ–Ω–µ–µ —Ç—è–∂—ë–ª–æ–µ"
        )

    # 5xx
    if code and code.startswith("5"):
        return (
            f"{header}\n\n"
            "–°–µ—Ä–≤–∏—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (–æ—à–∏–±–∫–∞ 5xx). –ü–æ–ø—Ä–æ–±—É–π –ø–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–∑–∂–µ."
        )

    # Fallback
    return (
        f"{header}\n\n"
        "–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n"
        "‚Ä¢ –í—Ä–µ–º–µ–Ω–Ω—ã–π —Å–±–æ–π —Å–µ—Ä–≤–∏—Å–∞ –∏–ª–∏ —Å–µ—Ç–∏\n"
        "‚Ä¢ –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –≤—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ\n"
        "‚Ä¢ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –º–æ–¥–µ–ª–∏ –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É\n\n"
        "–ß—Ç–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å:\n"
        "‚Ä¢ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É\n"
        "‚Ä¢ –£–ø—Ä–æ—Å—Ç–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ\n"
        "‚Ä¢ –ó–∞–º–µ–Ω–∏—Ç—å —Ñ–æ—Ç–æ –Ω–∞ –¥—Ä—É–≥–æ–µ\n"
        "‚Ä¢ –ï—Å–ª–∏ –ø–æ–≤—Ç–æ—Ä—è–µ—Ç—Å—è ‚Äî –Ω–∞–∂–º–∏ ¬´–°–æ–æ–±—â–∏—Ç—å –æ–± –æ—à–∏–±–∫–µ¬ª"
    )
